---
# tasks file for dns

- name: Check for DNS File
  stat:
    path: .dns
  register: dns

- block:
  - name: Check for VPN File
    stat:
      path: .vpn
    register: vpn

  - include_tasks: ../utils/install.yml
    loop:
      - systemd-resolved

  - name: Enable Systemd-Resolved
    become: true
    service:
      enabled: true
      name: systemd-resolved
      state: started

  - name: Create Resolve Symlink
    become: true
    file:
      state: link
      force: true
      src: /run/systemd/resolve/resolv.conf
      path: /etc/resolv.conf

  - name: Disable DNS Stub Listener
    become: true
    lineinfile:
      path: /etc/systemd/resolved.conf
      regexp: "#?DNSStubListener=yes"
      line: DNSStubListener=no
    register: resolvedconf

  - name: Restart Systemd-Resolved
    become: true
    service:
      name: systemd-resolved
      state: restarted
    when: resolvedconf.changed

  - name: Enable IP Forwarding
    become: true
    ansible.posix.sysctl:
      value: 1
      name: "{{ item }}"
    loop:
      - net.ipv4.ip_forward
      - net.ipv6.conf.all.forwarding
    when: "vpn.stat.exists"
  when: "dns.stat.exists"
