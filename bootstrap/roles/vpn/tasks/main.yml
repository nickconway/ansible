---
# tasks file for vpn

- name: Create VPN File
  file:
    path: ~/.vpn
    state: touch
    mode: '600'
  when: "'vpn' in group_names"

- name: Check for VPN File
  stat:
    path: ~/.vpn
  register: vpn

- block:
  - name: Create Server File
    file:
      path: ~/.server
      state: touch
      mode: '600'
    when: "'servers' in group_names"

  - name: Check for Server File
    stat:
      path: ~/.server
    register: server

  - name: Create Client-Server File
    file:
      path: ~/.client-server
      state: touch
      mode: '600'
    when: "'client-server' in group_names"

  - name: Check for Client-Server File
    stat:
      path: ~/.client-server
    register: client_server

  - name: Create DNS File
    file:
      path: ~/.dns
      state: touch
      mode: '600'
    when: "'dns' in group_names"

  - name: Check for DNS File
    stat:
      path: ~/.dns
    register: dns

  - name: Create Work File
    file:
      path: ~/.work
      state: touch
      mode: '600'
    when: "'work' in group_names"

  - name: Check for Work File
    stat:
      path: ~/.work
    register: work

  - name: Get Current User
    shell:
      cmd: whoami
    register: current_user
    changed_when: false

  - name: Create Default Flags
    set_fact:
      flags: "--ssh --operator={{ current_user.stdout }} --authkey {{ vpn_key }}"

  - block:
    - name: Add Client-Server Flags
      set_fact:
        flags: "{{ flags }} --advertise-tags=tag:server,tag:client"
    when: "client_server.stat.exists"

  - block:
    - name: Add Server Flags
      set_fact:
        flags: "{{ flags }} --advertise-tags=tag:server"
    when: "server.stat.exists"

  - block:
    - name: Add DNS Flags
      set_fact:
        flags: "{{ flags }} --accept-dns=false --advertise-routes=10.0.10.0/24,10.0.107.0/24"
    when: "dns.stat.exists"

  - block:
    - name: Add Work Flags
      set_fact:
        flags: "{{ flags }} --advertise-tags=tag:work"
    when: work.stat.exists

  - block:
    - name: Add Accept Routes Flags
      set_fact:
        flags: echo "{{ flags }} --accept-routes"
    when: not ansible_default_ipv4.address.startswith('10.0.10') and
          not ansible_default_ipv4.address.startswith('10.0.107')

  - name: Install Tailscale
    become: true
    shell:
      cmd: curl -fsSL https://tailscale.com/install.sh | sh
    changed_when: false

  - name: Enable IP Forwarding
    become: true
    lineinfile:
      create: true
      path: /etc/sysctl.d/99-tailscale.conf
      line: "{{ item }}"
    loop:
      - net.ipv4.ip_forward = 1
      - net.ipv6.conf.all.forwarding = 1
    when: "dns.stat.exists"

  - name: Reload Sysctl
    become: true
    shell:
      cmd: sysctl -p /etc/sysctl.d/99-tailscale.conf
    when: "dns.stat.exists"
    changed_when: false

  - name: Connect to VPN
    become: true
    shell:
      cmd: tailscale up {{ flags }}
    changed_when: false

  - name: Enable Auto-Updates
    become: true
    shell:
      cmd: tailscale set --auto-update
    changed_when: false
  when: "vpn.stat.exists"
